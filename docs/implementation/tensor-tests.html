<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tensor Operations Tests</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            line-height: 1.6;
        }
        .test-panel {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .test-results {
            font-family: monospace;
            white-space: pre;
            padding: 10px;
            background: #f1f3f5;
            border-radius: 4px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        .success { color: #2b8a3e; }
        .failure { color: #c92a2a; }
        button {
            background: #339af0;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1c7ed6;
        }
    </style>
</head>
<body>
    <h1>Tensor Operations Tests</h1>
    
    <div class="test-panel">
        <h2>2-Valent Node Tests</h2>
        <p>Tests identity tensor for matching spins and zero tensor for mismatched spins</p>
        <button onclick="run2ValentTests()">Run 2-Valent Tests</button>
        <div id="results-2v" class="test-results">No tests run yet</div>
    </div>

    <div class="test-panel">
        <h2>3-Valent Node Tests</h2>
        <p>Tests triangle inequality and intertwiner dimension for 3-valent nodes</p>
        <button onclick="run3ValentTests()">Run 3-Valent Tests</button>
        <div id="results-3v" class="test-results">No tests run yet</div>
    </div>

    <div class="test-panel">
        <h2>4-Valent Node Tests</h2>
        <p>Tests intertwiner space dimension and basis states for 4-valent nodes</p>
        <button onclick="run4ValentTests()">Run 4-Valent Tests</button>
        <div id="results-4v" class="test-results">No tests run yet</div>
    </div>

    <script src="../../dist/lib/spin-network.umd.js"></script>
    <script>
        // Helper to format test results
        function formatResult(name, passed, details) {
            return `${passed ? '✓' : '✗'} ${name}\n${details ? '  ' + details + '\n' : ''}`;
        }

        // 2-valent node tests
        function run2ValentTests() {
            const results = [];
            const resultsDiv = document.getElementById('results-2v');
            
            try {
                // Test matching spins (j₁ = j₂ = 1/2)
                const j1 = 0.5, j2 = 0.5;
                const matchingNode = window.SpinNetwork.createTensorNode(
                    'test-2v-match',
                    { x: 0, y: 0 },
                    0,
                    [2, 2] // dimensions = 2j+1 for j=1/2
                );

                results.push(`Testing 2-valent node with spins: j₁=${j1}, j₂=${j2}`);
                results.push(`Dimensions: [${matchingNode.tensor.dimensions.join(', ')}]`);
                results.push('Expected: Identity tensor for matching spins\n');

                // Check identity tensor elements
                let identityPassed = true;
                const identityElements = [];
                
                for (let i = 0; i < 2; i++) {
                    for (let j = 0; j < 2; j++) {
                        const element = window.SpinNetwork.getTensorElement(matchingNode.tensor, [i, j]);
                        const expected = i === j ? 1 : 0;
                        const pass = Math.abs(element.re - expected) < 1e-10;
                        identityElements.push(`[${i},${j}] = ${element.re.toFixed(4)} (expected: ${expected}) ${pass ? '✓' : '✗'}`);
                        if (!pass) identityPassed = false;
                    }
                }
                
                results.push('Identity tensor elements:');
                results.push(identityElements.join('\n'));
                results.push(`Identity test: ${identityPassed ? 'PASSED ✓' : 'FAILED ✗'}\n`);

                // Test mismatched spins (j₁ = 1/2, j₂ = 1)
                const j1m = 0.5, j2m = 1.0;
                results.push(`Testing mismatched spins: j₁=${j1m}, j₂=${j2m}`);
                
                const mismatchedNode = window.SpinNetwork.createTensorNode(
                    'test-2v-mismatch',
                    { x: 0, y: 0 },
                    0,
                    [2, 3] // dimensions for j₁=1/2 and j₂=1
                );

                results.push(`Dimensions: [${mismatchedNode.tensor.dimensions.join(', ')}]`);
                results.push('Expected: Zero tensor for mismatched spins\n');

                // Check zero tensor elements
                let zeroPassed = true;
                const zeroElements = [];
                
                for (let i = 0; i < 2; i++) {
                    for (let j = 0; j < 3; j++) {
                        const element = window.SpinNetwork.getTensorElement(mismatchedNode.tensor, [i, j]);
                        const pass = Math.abs(element.re) < 1e-10;
                        zeroElements.push(`[${i},${j}] = ${element.re.toFixed(4)} ${pass ? '✓' : '✗'}`);
                        if (!pass) zeroPassed = false;
                    }
                }
                
                results.push('Tensor elements (should all be zero):');
                results.push(zeroElements.join('\n'));
                results.push(`Zero tensor test: ${zeroPassed ? 'PASSED ✓' : 'FAILED ✗'}`);

            } catch (error) {
                results.push(`ERROR: ${error.message}`);
            }

            resultsDiv.innerHTML = results.join('\n');
            resultsDiv.className = 'test-results ' + 
                (results.every(r => !r.includes('✗') && !r.includes('ERROR')) ? 'success' : 'failure');
        }

        // 3-valent node tests
        function run3ValentTests() {
            const results = [];
            const resultsDiv = document.getElementById('results-3v');
            
            try {
                // Test valid triangle (j₁=1/2, j₂=1/2, j₃=1)
                const j1 = 0.5, j2 = 0.5, j3 = 1.0;
                results.push(`Testing 3-valent node with spins: j₁=${j1}, j₂=${j2}, j₃=${j3}`);
                
                // Check triangle inequalities
                const triIneq1 = j1 + j2 >= j3;
                const triIneq2 = j2 + j3 >= j1;
                const triIneq3 = j3 + j1 >= j2;
                
                results.push('\nTriangle inequality checks:');
                results.push(`j₁ + j₂ ≥ j₃: ${j1} + ${j2} = ${j1+j2} ≥ ${j3} : ${triIneq1 ? '✓' : '✗'}`);
                results.push(`j₂ + j₃ ≥ j₁: ${j2} + ${j3} = ${j2+j3} ≥ ${j1} : ${triIneq2 ? '✓' : '✗'}`);
                results.push(`j₃ + j₁ ≥ j₂: ${j3} + ${j1} = ${j3+j1} ≥ ${j2} : ${triIneq3 ? '✓' : '✗'}`);
                
                const validNode = window.SpinNetwork.createTensorNode(
                    'test-3v-valid',
                    { x: 0, y: 0 },
                    0,
                    [2, 2, 3] // dimensions for spins 1/2, 1/2, 1
                );

                results.push(`\nDimensions: [${validNode.tensor.dimensions.join(', ')}]`);
                results.push(`Intertwiner dimension: ${validNode.intertwiner.dimension}`);
                
                // Show non-zero tensor elements
                const elements = validNode.tensor.elements;
                if (elements.length > 0) {
                    results.push('\nNon-zero tensor elements:');
                    elements.forEach(el => {
                        results.push(`[${el.indices.join(',')}] = ${el.value.re.toFixed(4)}${el.value.im !== 0 ? ' + ' + el.value.im.toFixed(4) + 'i' : ''}`);
                    });
                }
                
                results.push(`\nValid triangle test: ${elements.length > 0 ? 'PASSED ✓' : 'FAILED ✗'}`);

                // Test invalid triangle (j₁=1/2, j₂=1/2, j₃=2)
                const j1i = 0.5, j2i = 0.5, j3i = 2.0;
                results.push(`\nTesting invalid configuration: j₁=${j1i}, j₂=${j2i}, j₃=${j3i}`);
                
                // Check triangle inequalities for invalid case
                const triIneq1i = j1i + j2i >= j3i;
                const triIneq2i = j2i + j3i >= j1i;
                const triIneq3i = j3i + j1i >= j2i;
                
                results.push('\nTriangle inequality checks:');
                results.push(`j₁ + j₂ ≥ j₃: ${j1i} + ${j2i} = ${j1i+j2i} ≥ ${j3i} : ${triIneq1i ? '✓' : '✗'}`);
                results.push(`j₂ + j₃ ≥ j₁: ${j2i} + ${j3i} = ${j2i+j3i} ≥ ${j1i} : ${triIneq2i ? '✓' : '✗'}`);
                results.push(`j₃ + j₁ ≥ j₂: ${j3i} + ${j1i} = ${j3i+j1i} ≥ ${j2i} : ${triIneq3i ? '✓' : '✗'}`);
                
                const invalidNode = window.SpinNetwork.createTensorNode(
                    'test-3v-invalid',
                    { x: 0, y: 0 },
                    0,
                    [2, 2, 5] // dimensions for spins 1/2, 1/2, 2
                );

                results.push(`\nDimensions: [${invalidNode.tensor.dimensions.join(', ')}]`);
                results.push(`Intertwiner dimension: ${invalidNode.intertwiner.dimension}`);
                
                const invalidElements = invalidNode.tensor.elements;
                results.push(`\nInvalid triangle test: ${invalidElements.length === 0 ? 'PASSED ✓' : 'FAILED ✗'}`);

            } catch (error) {
                results.push(`\nERROR: ${error.message}`);
            }

            resultsDiv.innerHTML = results.join('\n');
            resultsDiv.className = 'test-results ' + 
                (!results.join('').includes('✗') && !results.join('').includes('ERROR') ? 'success' : 'failure');
        }

        // 4-valent node tests
        function run4ValentTests() {
            const results = [];
            const resultsDiv = document.getElementById('results-4v');
            
            try {
                // Test four spin-1/2 edges
                const j1 = 0.5, j2 = 0.5, j3 = 0.5, j4 = 0.5;
                const intermediateJ = 1;
                
                results.push(`Testing 4-valent node:`);
                results.push(`Spins: j₁=${j1}, j₂=${j2}, j₃=${j3}, j₄=${j4}`);
                results.push(`Intermediate coupling j=${intermediateJ}\n`);

                const node = window.SpinNetwork.createTensorNode(
                    'test-4v-basic',
                    { x: 0, y: 0 },
                    intermediateJ,
                    [2, 2, 2, 2] // dimensions for four spin-1/2 edges
                );

                // Show recoupling scheme
                results.push(`Recoupling scheme: ${node.intertwiner.recouplingScheme || '(j₁,j₂)(j₃,j₄)'}`);
                
                // Show allowed intermediate spins
                const j12min = Math.abs(j1 - j2);
                const j12max = j1 + j2;
                const j34min = Math.abs(j3 - j4);
                const j34max = j3 + j4;
                
                results.push('\nAllowed intermediate spins:');
                results.push(`j₁₂: |j₁-j₂| ≤ j₁₂ ≤ j₁+j₂ : ${j12min} ≤ j₁₂ ≤ ${j12max}`);
                results.push(`j₃₄: |j₃-j₄| ≤ j₃₄ ≤ j₃+j₄ : ${j34min} ≤ j₃₄ ≤ ${j34max}`);
                
                // Show intertwiner dimension
                results.push(`\nIntertwiner space dimension: ${node.intertwiner.dimension}`);
                
                // Show tensor dimensions and structure
                results.push(`\nTensor dimensions: [${node.tensor.dimensions.join(', ')}]`);
                
                // Show non-zero tensor elements
                const elements = node.tensor.elements;
                if (elements.length > 0) {
                    results.push('\nNon-zero tensor elements:');
                    elements.forEach(el => {
                        const val = el.value;
                        results.push(`[${el.indices.join(',')}] = ${val.re.toFixed(4)}${val.im !== 0 ? ' + ' + val.im.toFixed(4) + 'i' : ''}`);
                    });
                }

                // Verify normalization
                let normSquared = 0;
                elements.forEach(el => {
                    normSquared += el.value.re * el.value.re + el.value.im * el.value.im;
                });
                
                results.push(`\nTensor normalization: ${Math.abs(normSquared - 1) < 1e-10 ? 'PASSED ✓' : 'FAILED ✗'}`);
                results.push(`(|T|² = ${normSquared.toFixed(10)})`);

            } catch (error) {
                results.push(`\nERROR: ${error.message}`);
            }

            resultsDiv.innerHTML = results.join('\n');
            resultsDiv.className = 'test-results ' + 
                (!results.join('').includes('✗') && !results.join('').includes('ERROR') ? 'success' : 'failure');
        }
    </script>
</body>
</html>
